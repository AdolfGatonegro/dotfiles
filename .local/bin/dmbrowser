#!/bin/sh
# gatoneg.ro
# search from dmenu, open regular or private tabs, a minimal session,
# create a temporary vanilla firefox profile, or perform searches

browserCmd="$BROWSER -new-tab"
browserPrivateCmd="$BROWSER -private-window"
browserMinimalCmd="$BROWSER -P Minimal --class=\"minimal\""
urlregex="^([a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]\.)+[a-zA-Z]{2,}$"
defaultSearch="https://northboot.xyz/search?q="
youtubeSearch="https://www.youtube.com/results?search_query="

tmp_session() {
	PROFILEDIR=$(mktemp -p /tmp -d tmpsession.XXXXXX.d)
	$BROWSER -profile "$PROFILEDIR" -no-remote -new-instance
	rm -rf $PROFILEDIR
}

declare -a options=(
	"New tab"
	"New private tab"
	"Minimal session"
	"Temporary session"
	"YouTube search"
	"Exit"
)

choice=$(printf '%s\n' "${options[@]}" | dmenu -i -l 20 -p "${BROWSER}:")

case $choice in
	"New tab")
		${browserCmd} "about:blank" & disown ;;
	"New private tab")
		${browserPrivateCmd} & disown ;;
	"Minimal session")
		${browserMinimalCmd} & disown ;;
	"Temporary session")
		tmp_session;;
	"YouTube search")
		searchString=$(:| dmenu -p "${choice}:")
		[ -n "$searchString" ] && ${browserMinimalCmd} "${youtubeSearch}${searchString}" & disown
		;;
	"Exit")
		exit 0 ;;
	# When $choice doesn't match any options, check if it's a valid URL.
	# If it matches the regex, open the URL. Otherwise, pass it to the search engine.
	*)	[[ -z "$choice" ]] && exit 0 ||
		if [[ $choice =~ $urlregex ]]; then ${browserMinimalCmd} "$choice" & disown;
		else ${browserMinimalCmd} "${defaultSearch}${choice}" & disown; fi;;
esac

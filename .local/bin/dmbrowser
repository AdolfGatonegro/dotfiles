#!/bin/sh
# gatoneg.ro
#
# Use dmenu as a system-wide browser menu and URL bar. Open a new default tab,
# a new minimal session, create a disposable vanilla profile, or perform
# searches directly from dmenu.

# Browser commands
browserCmd="$BROWSER -new-tab"
browserMinCmd="$BROWSER -P Minimal --class=\"minimal\""
urlregex="^((https?|ftps?)://)?[^\s/$.?#]+\.[^\s/$.?#]+[^\s]*$"

# Search engines
defaultSearch="https://northboot.xyz/search?q="
googleSearch="https://google.com/search?hl=en&q="
wikipediaSearch="https://en.wikipedia.org/wiki/Special:Search/"
youtubeSearch="https://youtube.com/results?search_query="

tmp_session() {
	PROFILEDIR=$(mktemp -p /tmp -d tmpsession.XXXXXX.d)
	$BROWSER -profile "$PROFILEDIR" -no-remote -new-instance
	rm -rf $PROFILEDIR
}

declare -a options=(
	" New tab"
	"﫸 Minimal session"
	"屢 Temporary session"
	" Bookmarks"
	" Google"
	" Wikipedia"
	" YouTube"
	"ﴚ Exit"
)

choice=$(printf '%s\n' "${options[@]}" | dmenu -i -l 20 -p "${BROWSER}:")

search(){
	searchString=$(:| dmenu -p "${choice}:")
	[ -n "$searchString" ] && ${browserMinCmd} "$1${searchString}" & disown
}

case $choice in
	" New tab") ${browserCmd} "about:blank" & disown ;;
	"﫸 Minimal session") ${browserMinCmd} & disown ;;
	"屢 Temporary session") tmp_session;;
	" Bookmarks") bmks & exit 0;;
	" Google") search $googleSearch;;
	" Wikipedia") search $wikipediaSearch;;
	" YouTube") search $youtubeSearch;;
	"ﴚ Exit") exit 0 ;;
	# When user input doesn't match any choice, check if it's a valid URL. If
	# it is, open it in the browser, otherwise treat it as a search string.
	*)	[[ -z "$choice" ]] && exit 0 ||
		if [[ $choice =~ $urlregex ]]; then ${browserMinCmd} "$choice" & disown;
		else ${browserMinCmd} "${defaultSearch}${choice}" & disown; fi;;
esac
